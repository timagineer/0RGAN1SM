const CONSTANTS={PARTICLE_COUNT:1080,ANNOUNCEMENT_THROTTLE:2e3,PI:Math.PI,PI_180:Math.PI/180,DEFAULT_VALUES:{size:2.5,canvas:120,circulation:720,mutation:18,metabolism:12}},DEBUG=!1;function debugLog(...e){DEBUG&&console.log("[Organism]",...e)}function measurePerformance(e,t){return function(...n){const a=performance.now();try{const o=e.apply(this,n),r=performance.now();return debugLog(`${t} took ${(r-a).toFixed(2)}ms`),o}catch(e){throw console.error(`Error in ${t}:`,e),e}}}class LiveRegionManager{constructor(){this.liveRegion=document.getElementById("js-live-region"),this.lastAnnouncement="",this.lastAnnouncementTime=0}announce(e,t=!1){const n=Date.now();(t||e!==this.lastAnnouncement&&n-this.lastAnnouncementTime>=CONSTANTS.ANNOUNCEMENT_THROTTLE)&&(this.liveRegion.textContent=e,this.lastAnnouncement=e,this.lastAnnouncementTime=n)}}class OrganismState{constructor(){this.state={},this.urlStateManager=new URLStateManager}save(){const e={functions:this.getFunctionSelections(),parameters:this.getParameterValues(),timestamp:Date.now()};try{this.urlStateManager.saveToURL(e),debugLog("State saved to URL")}catch(e){debugLog("Failed to save state to URL:",e)}}load(){const e=this.urlStateManager.loadFromURL();return!!e&&(this.applyState(e),debugLog("State loaded from URL"),!0)}getFunctionSelections(){return{impulseX:document.querySelector('input[name="impulse-x"]:checked')?.value??"sin",impulseY:document.querySelector('input[name="impulse-y"]:checked')?.value??"cos",resonanceX:document.querySelector('input[name="resonance-x"]:checked')?.value??"sin",resonanceY:document.querySelector('input[name="resonance-y"]:checked')?.value??"cos"}}getParameterValues(){const e={};return Object.keys(this.controls).forEach((t=>{e[t]=parseFloat(this.controls[t].value)})),e}applyState(e){if(e.functions){const t={impulseX:"impulse-x",impulseY:"impulse-y",resonanceX:"resonance-x",resonanceY:"resonance-y"};Object.entries(e.functions).forEach((([e,n])=>{const a=t[e];if(a){const e=document.querySelector(`input[name="${a}"][value="${n}"]`);e&&(e.checked=!0)}}))}e.parameters&&Object.entries(e.parameters).forEach((([e,t])=>{this.controls[e]&&(this.controls[e].value=t)})),updateAnimation()}}class URLStateManager{constructor(){}saveToURL(e){try{const t=this.createCleanHash(e);window.location.hash=t}catch(e){debugLog("Failed to save to URL:",e)}}loadFromURL(){try{const e=window.location.hash.slice(1);return e?this.parseCleanHash(e):null}catch(e){return debugLog("Failed to load from URL:",e),null}}createCleanHash(e){const{functions:t,parameters:n}=e,a={impulseX:"IX",impulseY:"IY",resonanceX:"RX",resonanceY:"RY"},o={size:"CS",canvas:"T",circulation:"D",mutation:"M",metabolism:"ME"};let r="";return Object.entries(t).forEach((([e,t])=>{const n=a[e];n&&(r+=n+t+"-")})),Object.entries(n).forEach((([e,t])=>{const n=o[e];if(n){const e=Math.round(10*t)/10;r+=n+e+"-"}})),r=r.slice(0,-1),r}parseCleanHash(e){const t={IX:"impulseX",IY:"impulseY",RX:"resonanceX",RY:"resonanceY"},n={CS:"size",T:"canvas",D:"circulation",M:"mutation",ME:"metabolism"},a={},o={},r=e.split("-");for(const e of r){if(e.length>=5){const n=e.substring(0,2);if(t[n]){const o=e.substring(2);if(["sin","cos","tan","asin","acos","atan"].includes(o)){a[t[n]]=o;continue}}}for(const[t,a]of Object.entries(n))if(e.startsWith(t)){const n=e.substring(t.length);if(n&&/^[\d.]+$/.test(n)){o[a]=parseFloat(n);break}}}return{functions:a,parameters:o,timestamp:Date.now()}}bindHashChange(){window.addEventListener("hashchange",(()=>{const e=this.loadFromURL();e&&void 0!==organismState&&void 0!==liveRegionManager&&(organismState.applyState(e),liveRegionManager.announce("Organism loaded from shared URL"))}))}getShareableURL(){const e={functions:organismState.getFunctionSelections(),parameters:organismState.getParameterValues(),timestamp:Date.now()};return this.saveToURL(e),window.location.href}}class ParticleSystem{constructor(e,t,n){this.container=e,this.particles=[],this.generateParticles(t,n)}generateParticles(e,t){const n=document.createDocumentFragment();for(let a=1;a<=e;a++){const e=document.createElement("q");e.className=t,e.style.setProperty("--i",a),this.particles.push(e),n.appendChild(e)}this.container.appendChild(n)}regenerateParticles(e,t){this.container.innerHTML="",this.particles=[],this.generateParticles(e,t)}updatePositions(e){this.particles.forEach(((t,n)=>{const a=e[n];a&&(t.style.setProperty("--x-1",`${a.x1}px`),t.style.setProperty("--y-1",`${a.y1}px`),t.style.setProperty("--x-2",`${a.x2}px`),t.style.setProperty("--y-2",`${a.y2}px`))}))}}class MathFunctionManager{constructor(){this.functions=this.createMathFunctions()}createMathFunctions(){return{sin:e=>{try{const t=Math.sin(e);return isFinite(t)?t:0}catch(e){return debugLog("Math.sin error:",e),0}},cos:e=>{try{const t=Math.cos(e);return isFinite(t)?t:0}catch(e){return debugLog("Math.cos error:",e),0}},tan:e=>{try{const t=Math.tan(e);return isFinite(t)?Math.max(-1e3,Math.min(1e3,t)):0}catch(e){return debugLog("Math.tan error:",e),0}},asin:e=>{try{const t=Math.asin(Math.max(-1,Math.min(1,e)));return isFinite(t)?t:0}catch(e){return debugLog("Math.asin error:",e),0}},acos:e=>{try{const t=Math.acos(Math.max(-1,Math.min(1,e)));return isFinite(t)?t:0}catch(e){return debugLog("Math.acos error:",e),0}},atan:e=>{try{const t=Math.atan(e);return isFinite(t)?t:0}catch(e){return debugLog("Math.atan error:",e),0}}}}getFunction(e){return this.functions[e]??this.functions.sin}}class ControlManager{constructor(){this.controls={},this.outputs={},this.init()}init(){this.buildControls(),this.bindEvents()}buildControls(){document.querySelectorAll(".js-range-input").forEach((e=>{this.controls[e.id.replace("js-","")]=e})),document.querySelectorAll(".c-control-value").forEach((e=>{this.outputs[e.id.replace("js-","").replace("-value","")]=e}))}bindEvents(){let e;Object.values(this.controls).forEach((t=>{t.addEventListener("input",(()=>{cancelAnimationFrame(e),e=requestAnimationFrame((()=>{updateAnimation(),organismState.save()}))}))})),[...document.querySelectorAll('input[name="impulse-x"]'),...document.querySelectorAll('input[name="impulse-y"]'),...document.querySelectorAll('input[name="resonance-x"]'),...document.querySelectorAll('input[name="resonance-y"]')].forEach((e=>{e.addEventListener("change",(()=>{updateAnimation(),announcePatternChange(),organismState.save()}))}))}updateOutputs(){Object.keys(this.controls).forEach((e=>{const t=this.controls[e],n=this.outputs[e];n&&(n.textContent=t.value,t.setAttribute("aria-valuenow",t.value))}))}}let liveRegionManager,mathFunctionManager,controlManager,organismState,organism,mainParticleSystem;function announcePatternChange(){const e=document.querySelector('input[name="impulse-x"]:checked')?.value??"sin",t=document.querySelector('input[name="impulse-y"]:checked')?.value??"cos",n=document.querySelector('input[name="resonance-x"]:checked')?.value??"sin",a=document.querySelector('input[name="resonance-y"]:checked')?.value??"cos",o=parseFloat(controlManager.controls.circulation?.value??720),r=parseFloat(controlManager.controls.mutation?.value??18),i=parseFloat(controlManager.controls.metabolism?.value??12);let s="";s+=o<240?"tight spiral ":o<720?"flowing wave ":o<1200?"expanding circle ":"chaotic swirl ",s+=r<20?"with subtle variation":r<45?"with moderate fluctuation":r<70?"with dynamic shifts":"with wild mutations",s+=i<5?", moving slowly":i<10?", at steady pace":i<15?", pulsing rapidly":", vibrating intensely";const c=`Organism pattern shifted to ${s}. Functions: ${[e,n,a,t].join(", ")}`;liveRegionManager.announce(c)}const KEYBOARD_SHORTCUTS={Space:()=>randomizeParameters(),Escape:()=>{document.activeElement&&document.activeElement!==document.body&&document.activeElement.blur()}};function randomizeParameters(){const e=["cos","sin","tan","acos","asin","atan"],t=e[Math.floor(Math.random()*e.length)],n=e[Math.floor(Math.random()*e.length)],a=e[Math.floor(Math.random()*e.length)],o=e[Math.floor(Math.random()*e.length)],r=document.querySelector(`input[name="impulse-x"][value="${t}"]`),i=document.querySelector(`input[name="impulse-y"][value="${n}"]`),s=document.querySelector(`input[name="resonance-x"][value="${a}"]`),c=document.querySelector(`input[name="resonance-y"][value="${o}"]`);r&&(r.checked=!0),i&&(i.checked=!0),s&&(s.checked=!0),c&&(c.checked=!0),controlManager.controls.size.value=(7.5*Math.random()+.5).toFixed(1),controlManager.controls.canvas.value=Math.floor(280*Math.random()+20),controlManager.controls.canvas.value=10*Math.floor(controlManager.controls.canvas.value/10),controlManager.controls.circulation.value=30*Math.floor(48*Math.random()+1),controlManager.controls.mutation.value=Math.floor(90*Math.random()+1),controlManager.controls.metabolism.value=(19*Math.random()+1).toFixed(1),updateAnimation(),announcePatternChange(),organismState.save()}const updateAnimation=measurePerformance((function(){try{controlManager.updateOutputs();const e=parseFloat(controlManager.controls.size.value),t=parseFloat(controlManager.controls.canvas.value),n=parseFloat(controlManager.controls.circulation.value)*CONSTANTS.PI_180,a=parseFloat(controlManager.controls.mutation.value),o=parseFloat(controlManager.controls.metabolism.value),r=document.querySelector('input[name="impulse-x"]:checked'),i=document.querySelector('input[name="impulse-y"]:checked'),s=document.querySelector('input[name="resonance-x"]:checked'),c=document.querySelector('input[name="resonance-y"]:checked'),l=r?mathFunctionManager.getFunction(r.value):mathFunctionManager.getFunction("sin"),u=i?mathFunctionManager.getFunction(i.value):mathFunctionManager.getFunction("cos"),m=s?mathFunctionManager.getFunction(s.value):mathFunctionManager.getFunction("sin"),h=c?mathFunctionManager.getFunction(c.value):mathFunctionManager.getFunction("cos"),d=document.documentElement;d.style.setProperty("--cell-size",e);const g=getComputedStyle(d).getPropertyValue("--metabolism-offset").trim()-o;d.style.setProperty("--organism-duration",`${g}s`);const p=[];for(let e=1;e<=CONSTANTS.PARTICLE_COUNT;e++){const o=a*e*CONSTANTS.PI_180,r=e*n/CONSTANTS.PARTICLE_COUNT;let i=l(o)*t,s=u(o)*t,c=m(r)*t,g=h(r)*t;const M=t*parseInt(getComputedStyle(d).getPropertyValue("--canvas-multiplier").trim());i=isFinite(i)?Math.max(-M,Math.min(M,i)):0,s=isFinite(s)?Math.max(-M,Math.min(M,s)):0,c=isFinite(c)?Math.max(-M,Math.min(M,c)):0,g=isFinite(g)?Math.max(-M,Math.min(M,g)):0,p.push({x1:i,y1:s,x2:c,y2:g})}mainParticleSystem.updatePositions(p)}catch(e){console.error("Animation update error:",e);const t=document.documentElement;t.style.setProperty("--cell-size",CONSTANTS.DEFAULT_VALUES.size),t.style.setProperty("--organism-duration","7s")}}),"updateAnimation");function setupRandomizeButton(){const e=document.querySelector(".js-randomize");e?e.addEventListener("click",(e=>{e.preventDefault(),randomizeParameters()})):console.error("Randomize button not found")}function initializeOrganism(){try{debugLog("Organism initializing..."),liveRegionManager=new LiveRegionManager,mathFunctionManager=new MathFunctionManager,controlManager=new ControlManager,organismState=new OrganismState,organismState.controls=controlManager.controls,organism=document.querySelector(".js-organism"),mainParticleSystem=new ParticleSystem(organism,CONSTANTS.PARTICLE_COUNT,"c-particle"),setupRandomizeButton(),organismState.urlStateManager.bindHashChange();organismState.load()||randomizeParameters(),debugLog("Organism initialization complete")}catch(e){console.error("Failed to initialize organism:",e),updateAnimation()}}document.addEventListener("keydown",(e=>{if(KEYBOARD_SHORTCUTS[e.code]&&!e.target.matches("input, button, a")&&(e.preventDefault(),KEYBOARD_SHORTCUTS[e.code]()),e.target.matches('input[type="range"]')){const t=e.target.step||1,n=parseFloat(e.target.value);if("ArrowUp"===e.code||"ArrowRight"===e.code){e.preventDefault();const a=Math.min(parseFloat(e.target.max),n+parseFloat(t));e.target.value=a,e.target.setAttribute("aria-valuenow",a),updateAnimation()}else if("ArrowDown"===e.code||"ArrowLeft"===e.code){e.preventDefault();const a=Math.max(parseFloat(e.target.min),n-parseFloat(t));e.target.value=a,e.target.setAttribute("aria-valuenow",a),updateAnimation()}}})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeOrganism):initializeOrganism();
